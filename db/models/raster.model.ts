// db/models/raster.model.ts
import { query } from '@db/db';
import { QueryResult } from 'pg';
import { AssociateWorkspace } from '@db/models/workspace_files.model';
import { fileTypes } from '@repository/fileTypes';
import { Identifier } from './indetifier.interface';
import { updateHandler } from '@utils/update.handler';
import { Geometry } from 'geojson';
import { Editable } from '@components/modal/EditModal';
import pLimit from 'p-limit';

const type = fileTypes['tif'];

export interface RasterFile extends Identifier, Editable {
  id?: string;
  file_name: string;
  file_path: string;
  file_size: number;
  user_id: string;
  upload_date?: string;
  description?: string;
  geom?: Geometry;
  srid?: number;
  is_global: boolean;
  raster_type?: string;
  create_at?: Date;
  updated_at?: Date;
}

// Guardar un nuevo archivo raster
// Sin guardar la imagen, eso lo hace el route.ts
export const saveRasterFile = async (
  rasterFile: RasterFile,
  workspaceId: string
): Promise<RasterFile> => {
  let id: string | undefined = '0';
  let geom: Geometry | null = null;
  if (rasterFile.geom) geom = rasterFile.geom;
  const result: QueryResult<RasterFile> = await query(
    `INSERT INTO ${type.table} 
       (file_name, file_path, file_size, description, user_id,
       srid, raster_type, is_global, geom, upload_date)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, ST_SetSRID($9::geometry, 4326), NOW())
       RETURNING *`,
    [
      rasterFile.file_name,
      rasterFile.file_path,
      rasterFile.file_size,
      rasterFile.description,
      rasterFile.user_id,
      rasterFile.srid,
      rasterFile.raster_type,
      rasterFile.is_global,
      geom ? JSON.stringify(geom) : null, // Convertir la geometría a JSON si existe
    ]
  );
  id = result.rows[0].id?.toString() ?? '0';
  if (workspaceId && workspaceId !== '0' && id !== '0')
    await AssociateWorkspace(id, workspaceId, 'tif');
  return result.rows[0];
};

// Obtener archivo raster por ID
export const getRasterFileById = async (id: string): Promise<RasterFile> => {
  const result: QueryResult<RasterFile> = await query(
    `SELECT ${type.parameters.join(', ')} FROM ${type.table} WHERE id = $1`,
    [id]
  );
  return result.rows[0];
};

export const getRasterFileByUserId = async (
  user_id: string
): Promise<RasterFile> => {
  const result: QueryResult<RasterFile> = await query(
    `SELECT ${type.parameters.join(', ')} FROM ${type.table} WHERE user_id = $1`,
    [user_id]
  );
  return result.rows[0];
};

// Obtener todos los archivos raster
export const getAllRasterFiles = async (): Promise<RasterFile[]> => {
  const result: QueryResult<RasterFile> = await query(
    `SELECT ${type.parameters.join(', ')} FROM ${type.table}`
  );
  return result.rows;
};

// Actualizar archivo raster por ID
export const updateRasterFile = async (updateFields: Partial<RasterFile>) => {
  const validFields: string[] = [
    'file_name',
    'file_path',
    'description',
    'raster_type',
    'is_global',
    'geom',
  ];
  return await updateHandler<RasterFile>(type.table, validFields, updateFields);
};

// Eliminar archivo raster por ID
export const deleteRasterFileById = async (id: string): Promise<RasterFile> => {
  const result = await query(
    `DELETE FROM ${type.table} WHERE id = $1 RETURNING *`,
    [id]
  );
  return result.rows[0];
};

export const filterRasters = async (
  northWest: { lat: number; lng: number },
  northEast: { lat: number; lng: number },
  southWest: { lat: number; lng: number },
  southEast: { lat: number; lng: number },
  date: Date
) => {
  const visionPolygon = `POLYGON((${northWest.lng} ${northWest.lat},${northEast.lng} ${northEast.lat}, ${southEast.lng} ${southEast.lat}, ${southWest.lng} ${southWest.lat},${northWest.lng} ${northWest.lat}))`;
  const formattedDate = date.toISOString().split('T')[0]; // Formatea la fecha a 'YYYY-MM-DD'

  console.log(`date`, formattedDate);
  const queryText = `
    SELECT 
      id, 
      file_name, 
      file_path, 
      ST_AsGeoJSON(geom) AS geom, 
      upload_date  
    FROM "GPG_RASTERS" 
    WHERE 
    id NOT IN (5792, 6010, 7444, 7328, 7422, 7237, 7764, 7027, 5872, 6297, 5708, 5838, 5402, 6017, 7561, 6401, 6186, 5537, 6864, 6351, 7499, 6069, 6350, 7540, 6253, 6132, 7281, 6697, 7056, 6727, 5559, 6093, 6372, 5560, 7282, 7494, 7203, 6040, 6374, 5721, 6390, 7005, 5476, 7396, 7712, 7745, 6089, 7619, 7430, 5880, 6930, 6139, 7654, 7342, 7601, 6088, 5791, 6429, 5388, 6125, 7028, 6890, 7525, 5549, 6851, 6197, 5879, 5767, 6631, 7368, 6699, 7562, 5458, 5956, 5655, 6773, 6426, 6352, 6319, 6140, 5504, 5907, 6677, 6252, 5774, 7462, 7555, 7549, 6656, 6757, 7467, 5681, 6389, 7521, 6137, 6551, 7650, 5585, 7736, 6084, 5622, 7239, 6670, 5490, 7610, 6345, 7721, 6115, 7129, 5972, 5600, 6330, 6840, 6936, 6614, 7630, 5700, 6335, 6116, 5908, 6879, 7641, 7359, 6492, 6932, 6212, 5466, 7523, 7440, 7559, 7694, 6865, 5994, 6030, 7021, 7264, 7106, 6047, 5983, 6205, 5989, 6312, 5875, 7299, 7046, 7159, 5547, 7639, 6412, 6403, 6620, 7455, 6248, 7460, 5469, 5835, 6903, 5646, 6579, 6170, 6021, 7427, 7312, 6051, 5859, 6745, 7180, 6464, 6059, 6887, 6635, 7254, 5993, 5470, 7435, 7590, 6289, 6342, 6603, 6085, 7655, 7413, 5609, 7535, 5888, 5629, 7303, 5706, 5755, 7305, 7195, 5965, 7187, 7473, 6843, 5847, 7405, 7107, 6541, 6034, 6098, 6900, 5871, 6565, 7057, 5367, 5747, 6813, 7062, 6884, 6608, 5806, 6455, 6855, 5409, 7152, 6661, 5960, 5906, 7742, 5422, 7565, 6174, 7409, 7705, 7421, 5395, 7703, 5962, 5487, 6596, 7185, 7571, 7456, 6393, 6717, 6245, 6703, 7003, 6158, 7156, 6346, 7543, 7341, 5512, 5723, 7589, 6437, 7713, 6889, 6196, 6812, 6265, 5958, 5475, 6019, 6415, 7030, 6165, 7382, 6824, 5436, 6649, 7486, 6321, 7337, 7539, 7306, 7182, 5583, 5703, 6904, 7756, 5606, 7376, 6680, 7301, 5576, 6789, 6655, 7419, 6207, 5511, 7262, 6456, 6870, 6810, 6937, 5787, 7225, 6606, 5944, 7307, 5455, 7082, 5552, 6553, 6117, 6963, 6933, 6595, 7646, 6643, 6962, 5605, 5456, 7377, 6659, 5831, 5371, 6928, 6948, 5860, 6997, 5832, 6706, 7029, 6958, 5513, 7634, 6691, 5732, 6087, 6454, 7759, 7620, 7323, 6783, 7738, 5873, 7388, 7357, 6605, 6081, 6896, 5381, 6509, 5673, 5874, 7517, 7189, 7515, 5949, 6130, 7355, 7356, 5463, 6965, 7629, 6892, 5881, 6261, 5790, 6540, 5522, 5498, 7068, 7179, 6777, 5468, 7468, 7519, 5691, 5444, 7105, 7690, 6027, 6232, 6993, 6845, 6952, 7431, 7426, 6543, 7083, 7524, 7123, 6270, 7061, 7294, 6989, 6169, 7433, 6746, 6793, 6303, 6557, 5788, 5775, 7378, 5827, 6830, 6950, 5625, 5988, 7325, 7261, 7452, 5375, 5990, 7447, 7175, 5418, 7606, 6368, 6012, 6221, 5603, 7172, 5897, 7636, 5895, 6719, 6910, 7393, 5867, 5660, 6276, 5982, 5863, 7596, 6981, 7672, 7037, 5566, 6015, 5474, 6224, 6759, 7141, 7206, 5668, 6320, 6850, 6771, 7707, 7008, 6083, 6517, 7493, 7420, 5848, 7400, 6229, 5536, 6447, 6689, 6046, 6452, 6846, 6906, 6377, 7000, 5529, 5919, 6381, 5495, 6708, 7066, 5729, 6323, 5506, 5987, 7708, 7055, 5917, 6718, 7491, 7681, 7709, 6075, 5712, 5813, 5926, 7196, 6258, 6491, 7317, 6180, 5842, 5678, 7665, 5839, 6767, 6919, 6839, 6065, 5533, 6521, 6076, 5760, 7275, 7563, 7608, 5518, 5558, 7677, 7751, 5985, 5857, 5406, 7216, 5754, 5915, 5781, 6683, 5713, 6000, 6658, 5588, 5561, 6315, 6705, 5416, 7689, 6618, 7320, 7666, 6111, 6223, 7746, 5877, 7600, 6942, 7483, 6285, 5799, 6949, 6827, 7675, 6573, 5818, 6563, 7399, 6616, 6262, 5554, 7505, 6931, 7598, 6763, 5421, 6246, 7652, 5876, 6666, 7609, 5607, 7397, 5743, 6505, 6829, 6525, 5442, 7362, 7215, 5843, 7292, 5991, 6487, 7449, 7036, 7087, 7734, 7528, 6485, 6280, 6799, 6054, 6806, 7290, 6891, 7398, 6801, 7193, 5852, 6141, 6832, 7060, 6609, 5460, 7072, 6684, 5514, 6369, 7340, 7454, 5659, 5574, 6967, 6443, 6347, 6213, 5443, 7495, 6449, 6512, 7004, 7696, 5862, 6182, 6988, 6470, 6032, 7389, 5885, 6249, 6873, 5545, 6074, 5464, 7637, 5714, 5564, 6225, 7479, 5431, 6530, 5974, 5452, 7401, 7470, 6575, 6503, 6869, 6121, 5789, 7214, 6593, 6427, 7370, 5631, 7502, 6332, 6079, 7383, 7520, 5733, 7286, 7611, 6657, 6425, 7358, 5581, 6035, 7053, 7544, 6155, 7582, 5869, 6601, 5718, 6552, 5663, 7228, 6428, 5366, 5796, 6546, 6112, 6501, 5887, 6959, 7081, 5457, 5694, 6597, 7469, 5777, 6154, 7408, 7402, 7302, 7395, 7222, 7513, 7490, 6370, 7724, 7501, 6431, 7332, 6972, 5964, 6016, 6309, 6364, 7429, 5903, 7415, 7011, 6716, 5649, 6101, 7273, 7199, 6400, 5914, 6828, 7169, 5921, 5405, 5772, 7285, 7167, 6646, 5858, 5922, 7054, 6990, 7252, 5981, 6446, 5909, 5645, 6984, 6788, 5955, 7350, 7136, 7445, 6791, 6479, 5658, 7034, 5617, 5924, 6953, 6274, 6217, 6404, 6876, 6247, 5500, 6941, 5967, 7632, 6024, 5890, 6097, 6466, 6238, 6001, 5539, 7480, 6634, 5630, 5784, 7392, 6504, 6418, 7438, 6859, 5640, 5454, 7715, 5472, 6106, 5439, 5571, 7092, 6153, 7204, 6711, 6107, 6187, 6273, 6574, 7700, 6395, 6387, 5773, 7530, 6817, 6994, 5886, 6823, 5378, 6955, 7755, 6826, 5644, 5543, 6874, 5815, 7236, 6357, 6918, 5856, 6637, 6142, 5501, 7178, 6311, 7293, 7329, 5702, 6687, 7111, 6091, 6326, 5771, 6985, 6534, 6061, 6294, 6168, 6159, 6872, 6653, 6913, 6279, 6524, 6189, 7035, 5954, 7296, 7181, 5615, 5891, 6226, 6382, 5912, 7188, 7048, 6778, 6798, 7504, 6361, 6002, 7022, 6241, 7186, 6188, 7551, 7691, 6301, 7584, 6961, 6576, 6862, 6071, 6242, 7633, 7173, 6707, 7664, 6752, 7191, 7552, 7114, 7597, 7671, 7485, 6029, 6734, 7529, 7754, 5415, 6520, 6203, 6998, 7730, 6566, 7100, 7147, 7130, 5817, 7149, 5731, 6134, 7344, 7558, 7314, 7669, 6681, 7347, 5507, 5567, 7065, 6230, 6008, 6343, 5401, 5503, 6623, 7458, 7033, 6526, 5826, 7626, 6255, 6671, 6754, 7385, 7235, 6665, 5593, 7627, 6728, 5677, 5695, 6571, 7109, 7284, 6866, 5715, 6700, 7150, 5594, 6567, 5496, 6875, 7058, 5819, 5582, 6510, 6325, 6776, 6822, 5399, 7227, 5540, 5961, 5637, 5902, 7289, 7209, 6538, 7579, 6092, 6522, 7016, 6338, 7643, 7013, 6588, 6861, 7567, 5525, 7250, 7146, 5565, 6586, 6852, 6626, 5597, 7155, 6624, 7723, 6199, 6772, 5440, 7009, 5592, 6549, 6715, 6254, 5373, 7238, 5390, 7295, 5621, 5563, 7015, 6911, 7547, 5870, 6676, 6394, 5479, 6459, 7686, 7682, 7268, 6731, 7091, 6784, 7110, 6523, 6502, 5690, 6306, 6927, 6472, 7617, 5553, 6770, 6902, 7569, 5604, 7353, 7049, 5793, 5414, 7576, 6836, 5800, 5434, 6334, 5374, 6650, 7127, 7732, 7394, 5499, 5898, 6419, 7115, 6118, 5590, 6480, 5372, 7297, 5509, 7121, 6286, 7140, 7729, 7453, 6668, 6037, 6764, 7017, 5966, 6396, 7572, 6939, 6580, 5911, 6086, 7132, 7645, 7352, 7717, 7752, 7465, 6760, 7550, 6489, 7406, 7334, 7148, 6191, 6240, 5904, 5502, 5697, 7144, 6424, 6360, 6013, 5905, 5397, 6096, 5804, 7482, 6471, 6632, 6905, 7346, 6144, 6779, 5587, 7667, 7451, 5577, 6239, 6560, 6202, 6578, 7725, 5762, 5528, 7586, 7047, 6622, 6515, 5864, 6638, 5523, 6838, 6060, 5918, 6914, 6177, 6556, 6288, 7288, 6340, 5614, 7349, 6748, 7324, 5952, 7151, 5836, 5379, 5927, 6612, 6209, 6379, 7720, 6166, 7659, 7574, 5555, 7673, 5427, 6103, 5849, 7194, 7512, 7207, 6124, 5704, 6327, 7762, 6450, 6536, 7246, 6192, 5532, 7142, 5855, 6036, 5671, 7274, 5685, 5711, 6467, 7685, 7496, 5612, 5680, 5462, 6809, 5746, 5701, 6781, 6805, 7078, 6857, 5570, 5579, 7461, 7661, 6528, 6198, 5928, 6642, 5586, 5951, 6070, 5779, 5698, 5383, 6228, 5925, 5932, 6439, 6146, 6073, 6053, 6954, 6639, 5752, 6837, 6494, 6803, 7760, 7743, 6964, 6957, 7308, 7253, 6808, 7684, 6067, 7704, 6678, 5975, 6039, 6179, 5688, 7649, 6667, 5765, 5562, 7040, 6907, 6152, 5997, 7278, 7098, 6171, 6733, 6980, 6009, 6462, 7711, 6968, 5766, 7200, 5798, 6688, 5764, 7487, 7044, 6625, 5753, 5998, 7612, 6925, 7532, 6211, 7748, 6647, 6868, 5584, 7580, 5722, 7042, 5569, 7670, 7080, 7593, 6267, 7386, 6547, 7265, 7492, 5950, 7587, 7497, 6901, 5854, 5538, 7615, 6042, 6633, 6298, 6354, 6308, 7153, 6947, 7163, 5669, 7373, 7310, 5382, 6243, 5692, 5986, 5948, 5978, 5893, 7245, 7638, 6055, 7162, 6157, 5786, 7554, 6129, 6442, 5481, 6044, 6448, 6465, 5894, 5757, 5664, 6478, 7475, 7758, 7371, 7640, 7271, 5710, 6362, 7366, 6986, 7488, 7414, 5424, 7541, 7369, 6894, 7621, 7727, 6582, 5489, 6475, 5471, 7309, 6860, 7484, 5808, 7279, 5853, 6231, 6555, 6275, 7025, 7710, 6592, 7442, 5369, 6587, 6858, 6971, 6272, 6375, 6821, 7131, 6795, 6814, 6416, 6991, 7026, 7223, 7190, 7322, 6151, 5730, 5749, 5883, 5992, 5620, 5497, 7367, 5778, 7277, 6610, 6481, 6743, 6722, 7113, 5530, 6219, 7242, 6056, 7757, 7331, 5398, 6435, 7744, 7244, 6100, 5973, 6468, 7553, 6545, 6264, 5433, 5365, 7518, 7090, 6602, 7658, 5971, 5851, 7728, 6765, 7124, 7537, 5689, 5686, 7481, 5803, 5783, 6147, 5619, 5411, 5613, 6787, 6938, 5821, 5930, 6542, 5526, 7360, 6167, 6644, 7343, 5709, 6973, 5446, 6818, 6713, 7122, 5377, 6499, 6058, 6385, 7128, 7476, 7101, 7577, 6992, 5943, 5744, 6284, 7379, 6004, 5542, 6365, 7714, 6627, 5896, 6577, 5801, 7560, 7527, 5699, 6175, 6548, 6216, 5996, 6995, 5408, 6162, 6006, 6908, 7197, 6218, 6660, 5720, 7457, 5920, 6652, 7139, 6003, 7263, 5572, 5413, 5423, 6233, 7315, 7702, 6497, 6519, 5805, 5810, 5524, 6983, 5969, 5968, 5521, 6651, 7070, 5467, 5841, 6584, 6314, 6434, 7158, 5742, 7741, 6739, 6410, 5575, 6080, 6281, 6185, 5761, 5453, 7063, 6041, 5984, 5679, 5738, 6796, 6266, 5999, 6398, 7403, 7108, 7258, 6790, 6287, 6923, 6979, 6269, 5716, 5516, 7059, 6014, 6378, 6078, 6562, 7313, 6057, 6099, 7623, 5420, 7471, 5913, 7750, 5866, 7260, 6498, 6215, 6183, 5486, 5589, 6675, 6568, 6877, 5389, 6495, 7508, 6640, 6094, 5807, 7220, 5666, 5734, 7165, 6143, 7622, 6380, 6318, 5672, 5573, 7441, 7424, 6367, 7464, 5892, 5392, 6645, 6105, 5977, 5782, 6300, 5845, 6539, 7089, 6648, 5519, 6782, 7002, 6956, 7280, 7134, 5534, 7230, 7733, 5820, 6413, 5900, 7701, 6050, 6307, 5651, 7012, 6359, 6569, 6457, 6304, 6483, 6420, 6970, 5931, 5643, 6128, 5449, 6924, 7096, 5508, 6049, 6339, 6737, 6922, 7570, 6353, 5844, 6341, 5480, 5437, 5828, 5384, 7064, 6712, 6068, 7625, 7628, 7607, 5628, 7448, 5728, 5959, 6696, 5724, 6150, 7007, 6726, 6940, 5970, 5368, 6761, 5386, 5429, 6383, 5393, 6820, 6113, 6730, 7213, 7170, 6422, 7283, 7024, 6440, 6444, 6176, 6257, 6613, 6966, 5748, 5438, 7099, 7731, 7507, 6095, 6102, 6104, 7319, 7595, 5601, 5674, 7259, 5705, 6488, 7177, 5759, 6591, 6220, 7648, 6373, 5809, 6507, 7102, 6619, 6944, 7269, 7695, 7071, 7428, 6348, 6064, 6600, 7372, 5419, 7423, 7660, 6156, 6694, 6848, 7434, 5840,
 5707, 7642, 6751, 7418, 6695, 5763, 6322, 6133, 6508, 5780, 7154, 6590, 6486, 6514, 5929, 6698, 5684, 6693, 6732, 5670, 6299, 7605, 5412, 6816, 5635, 6978, 7463, 6277, 7257, 7585, 7119, 6119, 7425, 7726, 6237, 7506, 7032, 7300, 5492, 5608, 7450, 7594, 7241, 6363, 7345, 6193, 6313, 7753, 6409, 7339, 7466, 6867, 7045, 7581, 7143, 5717, 7390, 5776, 5934, 7010, 7436, 5611, 7693, 7407, 5428, 6222, 7085, 6893, 6148, 6423, 6898, 5473, 5634, 7018, 5667, 6583, 5485, 5394, 6414, 7538, 7432, 6558, 6934, 5610, 7256, 7548, 6755, 7093, 7602, 7618, 5846, 7603, 6674, 5632, 6916, 7120, 6617, 7526, 7688, 7217, 7321, 7522, 7391, 6921, 7160, 6234, 5376, 5812, 6709, 7104, 6853, 6316, 7545, 6406, 6819, 6909, 6686, 7380, 6516, 6376, 6031, 5477, 6750, 6723, 6062, 7542, 7676, 6371, 5557, 6976, 6725, 5735, 6336, 6200, 6460, 7503, 5596, 6206, 5696, 5719, 6690, 7084, 6669, 5662, 7229, 6251, 7094, 7224, 6417, 5656, 7365, 7116, 5797, 6149, 5407, 5459, 7233, 6436, 5816, 6114, 6807, 6702, 6022, 6474, 5550, 7198, 6164, 5510, 7647, 5515, 5953, 6484, 7330, 6236, 5403, 7031, 5568, 7240, 7291, 6720, 7613, 7375, 7604, 7077, 5639, 5493, 5884, 7208, 6292, 5830, 6842, 6704, 7001, 7718, 5370, 6685, 6250, 7137, 7698, 6841, 7117, 5751, 6477, 7234, 7364, 7761, 6929, 7592, 6589, 6290, 6598, 6349, 5995, 5465, 7546, 6886, 7437, 7038, 6136, 7351, 6792, 6774, 5882, 6572, 5598, 6897, 5693, 6173, 6756, 6235, 6324, 6317, 7112, 6529, 7135, 7472, 6023, 5595, 6736, 5385, 6863, 6531, 6263, 7417, 7336, 6397, 6020, 7327, 6794, 7086, 6493, 6621, 6356, 6663, 5938, 5916, 7050, 6227, 6943, 6453, 7687, 5599, 6190, 7069, 5756, 5976, 6682, 6753, 7354, 6854, 7573, 6391, 7247, 5676, 6210, 7416, 6641, 6856, 6432, 5432, 7075, 6951, 7588, 7631, 6831, 5535, 5940, 5865, 5650, 7699, 6388, 5824, 6511, 5482, 6849, 6518, 6366, 6945, 7041, 5661, 6758, 7668, 7318, 7478, 6282, 5447, 6278, 6630, 7404, 6066, 6585, 6430, 6160, 7624, 5939, 5541, 6550, 6692, 6975, 7248, 7443, 6172, 7019, 7557, 7168, 6007, 6880, 6878, 5945, 5616, 5636, 7020, 5829, 5823, 6108, 7287, 7039) 
    AND
    ST_Intersects(
      ST_Force2D(geom),
      ST_GeomFromText('${visionPolygon}', 4326)
    )
    AND upload_date::date = '${formattedDate}'
    ;
  `;

  const queryText2 = `
    SELECT 
      id, 
      file_name, 
      file_path, 
      ST_AsGeoJSON(geom) AS geom, 
      upload_date  
    FROM "GPG_RASTERS" 
    WHERE 
    id NOT IN (5792, 6010, 7444, 7328, 7422, 7237, 7764, 7027, 5872, 6297, 5708, 5838, 5402, 6017, 7561, 6401, 6186, 5537, 6864, 6351, 7499, 6069, 6350, 7540, 6253, 6132, 7281, 6697, 7056, 6727, 5559, 6093, 6372, 5560, 7282, 7494, 7203, 6040, 6374, 5721, 6390, 7005, 5476, 7396, 7712, 7745, 6089, 7619, 7430, 5880, 6930, 6139, 7654, 7342, 7601, 6088, 5791, 6429, 5388, 6125, 7028, 6890, 7525, 5549, 6851, 6197, 5879, 5767, 6631, 7368, 6699, 7562, 5458, 5956, 5655, 6773, 6426, 6352, 6319, 6140, 5504, 5907, 6677, 6252, 5774, 7462, 7555, 7549, 6656, 6757, 7467, 5681, 6389, 7521, 6137, 6551, 7650, 5585, 7736, 6084, 5622, 7239, 6670, 5490, 7610, 6345, 7721, 6115, 7129, 5972, 5600, 6330, 6840, 6936, 6614, 7630, 5700, 6335, 6116, 5908, 6879, 7641, 7359, 6492, 6932, 6212, 5466, 7523, 7440, 7559, 7694, 6865, 5994, 6030, 7021, 7264, 7106, 6047, 5983, 6205, 5989, 6312, 5875, 7299, 7046, 7159, 5547, 7639, 6412, 6403, 6620, 7455, 6248, 7460, 5469, 5835, 6903, 5646, 6579, 6170, 6021, 7427, 7312, 6051, 5859, 6745, 7180, 6464, 6059, 6887, 6635, 7254, 5993, 5470, 7435, 7590, 6289, 6342, 6603, 6085, 7655, 7413, 5609, 7535, 5888, 5629, 7303, 5706, 5755, 7305, 7195, 5965, 7187, 7473, 6843, 5847, 7405, 7107, 6541, 6034, 6098, 6900, 5871, 6565, 7057, 5367, 5747, 6813, 7062, 6884, 6608, 5806, 6455, 6855, 5409, 7152, 6661, 5960, 5906, 7742, 5422, 7565, 6174, 7409, 7705, 7421, 5395, 7703, 5962, 5487, 6596, 7185, 7571, 7456, 6393, 6717, 6245, 6703, 7003, 6158, 7156, 6346, 7543, 7341, 5512, 5723, 7589, 6437, 7713, 6889, 6196, 6812, 6265, 5958, 5475, 6019, 6415, 7030, 6165, 7382, 6824, 5436, 6649, 7486, 6321, 7337, 7539, 7306, 7182, 5583, 5703, 6904, 7756, 5606, 7376, 6680, 7301, 5576, 6789, 6655, 7419, 6207, 5511, 7262, 6456, 6870, 6810, 6937, 5787, 7225, 6606, 5944, 7307, 5455, 7082, 5552, 6553, 6117, 6963, 6933, 6595, 7646, 6643, 6962, 5605, 5456, 7377, 6659, 5831, 5371, 6928, 6948, 5860, 6997, 5832, 6706, 7029, 6958, 5513, 7634, 6691, 5732, 6087, 6454, 7759, 7620, 7323, 6783, 7738, 5873, 7388, 7357, 6605, 6081, 6896, 5381, 6509, 5673, 5874, 7517, 7189, 7515, 5949, 6130, 7355, 7356, 5463, 6965, 7629, 6892, 5881, 6261, 5790, 6540, 5522, 5498, 7068, 7179, 6777, 5468, 7468, 7519, 5691, 5444, 7105, 7690, 6027, 6232, 6993, 6845, 6952, 7431, 7426, 6543, 7083, 7524, 7123, 6270, 7061, 7294, 6989, 6169, 7433, 6746, 6793, 6303, 6557, 5788, 5775, 7378, 5827, 6830, 6950, 5625, 5988, 7325, 7261, 7452, 5375, 5990, 7447, 7175, 5418, 7606, 6368, 6012, 6221, 5603, 7172, 5897, 7636, 5895, 6719, 6910, 7393, 5867, 5660, 6276, 5982, 5863, 7596, 6981, 7672, 7037, 5566, 6015, 5474, 6224, 6759, 7141, 7206, 5668, 6320, 6850, 6771, 7707, 7008, 6083, 6517, 7493, 7420, 5848, 7400, 6229, 5536, 6447, 6689, 6046, 6452, 6846, 6906, 6377, 7000, 5529, 5919, 6381, 5495, 6708, 7066, 5729, 6323, 5506, 5987, 7708, 7055, 5917, 6718, 7491, 7681, 7709, 6075, 5712, 5813, 5926, 7196, 6258, 6491, 7317, 6180, 5842, 5678, 7665, 5839, 6767, 6919, 6839, 6065, 5533, 6521, 6076, 5760, 7275, 7563, 7608, 5518, 5558, 7677, 7751, 5985, 5857, 5406, 7216, 5754, 5915, 5781, 6683, 5713, 6000, 6658, 5588, 5561, 6315, 6705, 5416, 7689, 6618, 7320, 7666, 6111, 6223, 7746, 5877, 7600, 6942, 7483, 6285, 5799, 6949, 6827, 7675, 6573, 5818, 6563, 7399, 6616, 6262, 5554, 7505, 6931, 7598, 6763, 5421, 6246, 7652, 5876, 6666, 7609, 5607, 7397, 5743, 6505, 6829, 6525, 5442, 7362, 7215, 5843, 7292, 5991, 6487, 7449, 7036, 7087, 7734, 7528, 6485, 6280, 6799, 6054, 6806, 7290, 6891, 7398, 6801, 7193, 5852, 6141, 6832, 7060, 6609, 5460, 7072, 6684, 5514, 6369, 7340, 7454, 5659, 5574, 6967, 6443, 6347, 6213, 5443, 7495, 6449, 6512, 7004, 7696, 5862, 6182, 6988, 6470, 6032, 7389, 5885, 6249, 6873, 5545, 6074, 5464, 7637, 5714, 5564, 6225, 7479, 5431, 6530, 5974, 5452, 7401, 7470, 6575, 6503, 6869, 6121, 5789, 7214, 6593, 6427, 7370, 5631, 7502, 6332, 6079, 7383, 7520, 5733, 7286, 7611, 6657, 6425, 7358, 5581, 6035, 7053, 7544, 6155, 7582, 5869, 6601, 5718, 6552, 5663, 7228, 6428, 5366, 5796, 6546, 6112, 6501, 5887, 6959, 7081, 5457, 5694, 6597, 7469, 5777, 6154, 7408, 7402, 7302, 7395, 7222, 7513, 7490, 6370, 7724, 7501, 6431, 7332, 6972, 5964, 6016, 6309, 6364, 7429, 5903, 7415, 7011, 6716, 5649, 6101, 7273, 7199, 6400, 5914, 6828, 7169, 5921, 5405, 5772, 7285, 7167, 6646, 5858, 5922, 7054, 6990, 7252, 5981, 6446, 5909, 5645, 6984, 6788, 5955, 7350, 7136, 7445, 6791, 6479, 5658, 7034, 5617, 5924, 6953, 6274, 6217, 6404, 6876, 6247, 5500, 6941, 5967, 7632, 6024, 5890, 6097, 6466, 6238, 6001, 5539, 7480, 6634, 5630, 5784, 7392, 6504, 6418, 7438, 6859, 5640, 5454, 7715, 5472, 6106, 5439, 5571, 7092, 6153, 7204, 6711, 6107, 6187, 6273, 6574, 7700, 6395, 6387, 5773, 7530, 6817, 6994, 5886, 6823, 5378, 6955, 7755, 6826, 5644, 5543, 6874, 5815, 7236, 6357, 6918, 5856, 6637, 6142, 5501, 7178, 6311, 7293, 7329, 5702, 6687, 7111, 6091, 6326, 5771, 6985, 6534, 6061, 6294, 6168, 6159, 6872, 6653, 6913, 6279, 6524, 6189, 7035, 5954, 7296, 7181, 5615, 5891, 6226, 6382, 5912, 7188, 7048, 6778, 6798, 7504, 6361, 6002, 7022, 6241, 7186, 6188, 7551, 7691, 6301, 7584, 6961, 6576, 6862, 6071, 6242, 7633, 7173, 6707, 7664, 6752, 7191, 7552, 7114, 7597, 7671, 7485, 6029, 6734, 7529, 7754, 5415, 6520, 6203, 6998, 7730, 6566, 7100, 7147, 7130, 5817, 7149, 5731, 6134, 7344, 7558, 7314, 7669, 6681, 7347, 5507, 5567, 7065, 6230, 6008, 6343, 5401, 5503, 6623, 7458, 7033, 6526, 5826, 7626, 6255, 6671, 6754, 7385, 7235, 6665, 5593, 7627, 6728, 5677, 5695, 6571, 7109, 7284, 6866, 5715, 6700, 7150, 5594, 6567, 5496, 6875, 7058, 5819, 5582, 6510, 6325, 6776, 6822, 5399, 7227, 5540, 5961, 5637, 5902, 7289, 7209, 6538, 7579, 6092, 6522, 7016, 6338, 7643, 7013, 6588, 6861, 7567, 5525, 7250, 7146, 5565, 6586, 6852, 6626, 5597, 7155, 6624, 7723, 6199, 6772, 5440, 7009, 5592, 6549, 6715, 6254, 5373, 7238, 5390, 7295, 5621, 5563, 7015, 6911, 7547, 5870, 6676, 6394, 5479, 6459, 7686, 7682, 7268, 6731, 7091, 6784, 7110, 6523, 6502, 5690, 6306, 6927, 6472, 7617, 5553, 6770, 6902, 7569, 5604, 7353, 7049, 5793, 5414, 7576, 6836, 5800, 5434, 6334, 5374, 6650, 7127, 7732, 7394, 5499, 5898, 6419, 7115, 6118, 5590, 6480, 5372, 7297, 5509, 7121, 6286, 7140, 7729, 7453, 6668, 6037, 6764, 7017, 5966, 6396, 7572, 6939, 6580, 5911, 6086, 7132, 7645, 7352, 7717, 7752, 7465, 6760, 7550, 6489, 7406, 7334, 7148, 6191, 6240, 5904, 5502, 5697, 7144, 6424, 6360, 6013, 5905, 5397, 6096, 5804, 7482, 6471, 6632, 6905, 7346, 6144, 6779, 5587, 7667, 7451, 5577, 6239, 6560, 6202, 6578, 7725, 5762, 5528, 7586, 7047, 6622, 6515, 5864, 6638, 5523, 6838, 6060, 5918, 6914, 6177, 6556, 6288, 7288, 6340, 5614, 7349, 6748, 7324, 5952, 7151, 5836, 5379, 5927, 6612, 6209, 6379, 7720, 6166, 7659, 7574, 5555, 7673, 5427, 6103, 5849, 7194, 7512, 7207, 6124, 5704, 6327, 7762, 6450, 6536, 7246, 6192, 5532, 7142, 5855, 6036, 5671, 7274, 5685, 5711, 6467, 7685, 7496, 5612, 5680, 5462, 6809, 5746, 5701, 6781, 6805, 7078, 6857, 5570, 5579, 7461, 7661, 6528, 6198, 5928, 6642, 5586, 5951, 6070, 5779, 5698, 5383, 6228, 5925, 5932, 6439, 6146, 6073, 6053, 6954, 6639, 5752, 6837, 6494, 6803, 7760, 7743, 6964, 6957, 7308, 7253, 6808, 7684, 6067, 7704, 6678, 5975, 6039, 6179, 5688, 7649, 6667, 5765, 5562, 7040, 6907, 6152, 5997, 7278, 7098, 6171, 6733, 6980, 6009, 6462, 7711, 6968, 5766, 7200, 5798, 6688, 5764, 7487, 7044, 6625, 5753, 5998, 7612, 6925, 7532, 6211, 7748, 6647, 6868, 5584, 7580, 5722, 7042, 5569, 7670, 7080, 7593, 6267, 7386, 6547, 7265, 7492, 5950, 7587, 7497, 6901, 5854, 5538, 7615, 6042, 6633, 6298, 6354, 6308, 7153, 6947, 7163, 5669, 7373, 7310, 5382, 6243, 5692, 5986, 5948, 5978, 5893, 7245, 7638, 6055, 7162, 6157, 5786, 7554, 6129, 6442, 5481, 6044, 6448, 6465, 5894, 5757, 5664, 6478, 7475, 7758, 7371, 7640, 7271, 5710, 6362, 7366, 6986, 7488, 7414, 5424, 7541, 7369, 6894, 7621, 7727, 6582, 5489, 6475, 5471, 7309, 6860, 7484, 5808, 7279, 5853, 6231, 6555, 6275, 7025, 7710, 6592, 7442, 5369, 6587, 6858, 6971, 6272, 6375, 6821, 7131, 6795, 6814, 6416, 6991, 7026, 7223, 7190, 7322, 6151, 5730, 5749, 5883, 5992, 5620, 5497, 7367, 5778, 7277, 6610, 6481, 6743, 6722, 7113, 5530, 6219, 7242, 6056, 7757, 7331, 5398, 6435, 7744, 7244, 6100, 5973, 6468, 7553, 6545, 6264, 5433, 5365, 7518, 7090, 6602, 7658, 5971, 5851, 7728, 6765, 7124, 7537, 5689, 5686, 7481, 5803, 5783, 6147, 5619, 5411, 5613, 6787, 6938, 5821, 5930, 6542, 5526, 7360, 6167, 6644, 7343, 5709, 6973, 5446, 6818, 6713, 7122, 5377, 6499, 6058, 6385, 7128, 7476, 7101, 7577, 6992, 5943, 5744, 6284, 7379, 6004, 5542, 6365, 7714, 6627, 5896, 6577, 5801, 7560, 7527, 5699, 6175, 6548, 6216, 5996, 6995, 5408, 6162, 6006, 6908, 7197, 6218, 6660, 5720, 7457, 5920, 6652, 7139, 6003, 7263, 5572, 5413, 5423, 6233, 7315, 7702, 6497, 6519, 5805, 5810, 5524, 6983, 5969, 5968, 5521, 6651, 7070, 5467, 5841, 6584, 6314, 6434, 7158, 5742, 7741, 6739, 6410, 5575, 6080, 6281, 6185, 5761, 5453, 7063, 6041, 5984, 5679, 5738, 6796, 6266, 5999, 6398, 7403, 7108, 7258, 6790, 6287, 6923, 6979, 6269, 5716, 5516, 7059, 6014, 6378, 6078, 6562, 7313, 6057, 6099, 7623, 5420, 7471, 5913, 7750, 5866, 7260, 6498, 6215, 6183, 5486, 5589, 6675, 6568, 6877, 5389, 6495, 7508, 6640, 6094, 5807, 7220, 5666, 5734, 7165, 6143, 7622, 6380, 6318, 5672, 5573, 7441, 7424, 6367, 7464, 5892, 5392, 6645, 6105, 5977, 5782, 6300, 5845, 6539, 7089, 6648, 5519, 6782, 7002, 6956, 7280, 7134, 5534, 7230, 7733, 5820, 6413, 5900, 7701, 6050, 6307, 5651, 7012, 6359, 6569, 6457, 6304, 6483, 6420, 6970, 5931, 5643, 6128, 5449, 6924, 7096, 5508, 6049, 6339, 6737, 6922, 7570, 6353, 5844, 6341, 5480, 5437, 5828, 5384, 7064, 6712, 6068, 7625, 7628, 7607, 5628, 7448, 5728, 5959, 6696, 5724, 6150, 7007, 6726, 6940, 5970, 5368, 6761, 5386, 5429, 6383, 5393, 6820, 6113, 6730, 7213, 7170, 6422, 7283, 7024, 6440, 6444, 6176, 6257, 6613, 6966, 5748, 5438, 7099, 7731, 7507, 6095, 6102, 6104, 7319, 7595, 5601, 5674, 7259, 5705, 6488, 7177, 5759, 6591, 6220, 7648, 6373, 5809, 6507, 7102, 6619, 6944, 7269, 7695, 7071, 7428, 6348, 6064, 6600, 7372, 5419, 7423, 7660, 6156, 6694, 6848, 7434, 5840,
 5707, 7642, 6751, 7418, 6695, 5763, 6322, 6133, 6508, 5780, 7154, 6590, 6486, 6514, 5929, 6698, 5684, 6693, 6732, 5670, 6299, 7605, 5412, 6816, 5635, 6978, 7463, 6277, 7257, 7585, 7119, 6119, 7425, 7726, 6237, 7506, 7032, 7300, 5492, 5608, 7450, 7594, 7241, 6363, 7345, 6193, 6313, 7753, 6409, 7339, 7466, 6867, 7045, 7581, 7143, 5717, 7390, 5776, 5934, 7010, 7436, 5611, 7693, 7407, 5428, 6222, 7085, 6893, 6148, 6423, 6898, 5473, 5634, 7018, 5667, 6583, 5485, 5394, 6414, 7538, 7432, 6558, 6934, 5610, 7256, 7548, 6755, 7093, 7602, 7618, 5846, 7603, 6674, 5632, 6916, 7120, 6617, 7526, 7688, 7217, 7321, 7522, 7391, 6921, 7160, 6234, 5376, 5812, 6709, 7104, 6853, 6316, 7545, 6406, 6819, 6909, 6686, 7380, 6516, 6376, 6031, 5477, 6750, 6723, 6062, 7542, 7676, 6371, 5557, 6976, 6725, 5735, 6336, 6200, 6460, 7503, 5596, 6206, 5696, 5719, 6690, 7084, 6669, 5662, 7229, 6251, 7094, 7224, 6417, 5656, 7365, 7116, 5797, 6149, 5407, 5459, 7233, 6436, 5816, 6114, 6807, 6702, 6022, 6474, 5550, 7198, 6164, 5510, 7647, 5515, 5953, 6484, 7330, 6236, 5403, 7031, 5568, 7240, 7291, 6720, 7613, 7375, 7604, 7077, 5639, 5493, 5884, 7208, 6292, 5830, 6842, 6704, 7001, 7718, 5370, 6685, 6250, 7137, 7698, 6841, 7117, 5751, 6477, 7234, 7364, 7761, 6929, 7592, 6589, 6290, 6598, 6349, 5995, 5465, 7546, 6886, 7437, 7038, 6136, 7351, 6792, 6774, 5882, 6572, 5598, 6897, 5693, 6173, 6756, 6235, 6324, 6317, 7112, 6529, 7135, 7472, 6023, 5595, 6736, 5385, 6863, 6531, 6263, 7417, 7336, 6397, 6020, 7327, 6794, 7086, 6493, 6621, 6356, 6663, 5938, 5916, 7050, 6227, 6943, 6453, 7687, 5599, 6190, 7069, 5756, 5976, 6682, 6753, 7354, 6854, 7573, 6391, 7247, 5676, 6210, 7416, 6641, 6856, 6432, 5432, 7075, 6951, 7588, 7631, 6831, 5535, 5940, 5865, 5650, 7699, 6388, 5824, 6511, 5482, 6849, 6518, 6366, 6945, 7041, 5661, 6758, 7668, 7318, 7478, 6282, 5447, 6278, 6630, 7404, 6066, 6585, 6430, 6160, 7624, 5939, 5541, 6550, 6692, 6975, 7248, 7443, 6172, 7019, 7557, 7168, 6007, 6880, 6878, 5945, 5616, 5636, 7020, 5829, 5823, 6108, 7287, 7039) 
    AND 
    ST_Intersects(
      ST_Force2D(geom),
      ST_GeomFromText($1, 4326)
    )
    AND upload_date::date = $2;
  `;

  console.log(`visionPolygon`, visionPolygon);
  console.log(`query`, queryText);

  const result = await query(queryText2, [visionPolygon, formattedDate]);

  return result.rows;
};

// Obtener el número total de archivos raster
export async function getTotalRasterFilesCount(): Promise<number> {
  const result: QueryResult<{ count: number }> = await query(
    `SELECT COUNT(*) as count FROM ${type.table};`
  );
  return parseInt(String(result.rows[0].count), 10);
}

// Obtener todos los archivos raster con paginación
export async function getAllRasterFilesWithPagination(
  limit: number,
  offset: number
): Promise<RasterFile[]> {
  const result: QueryResult<RasterFile> = await query(
    `SELECT ${type.parameters.join(', ')} 
     FROM ${type.table} 
     ORDER BY upload_date DESC 
     LIMIT $1 OFFSET $2`,
    [limit, offset]
  );
  return result.rows;
}

// Obtener el número total de archivos raster por workspaceId
export async function getTotalRastersByWorkspaceCount(
  workspaceId: string
): Promise<number> {
  const result: QueryResult<{ count: number }> = await query(
    `SELECT COUNT(*) as count 
     FROM ${type.table} rt 
     JOIN "GPG_WORKSPACE_FILES" wf ON rt.id = wf.file_id 
     WHERE wf.workspace_id = $1`,
    [workspaceId]
  );
  return parseInt(String(result.rows[0].count), 10);
}

// Obtener archivos raster por workspaceId con paginación
export async function getRasterByWorkspaceIdWithPagination(
  workspaceId: string,
  limit: number,
  offset: number
): Promise<RasterFile[]> {
  const result: QueryResult<RasterFile> = await query(
    `SELECT ${type.parameters.join(', ')} 
     FROM ${type.table} rt 
     JOIN "GPG_WORKSPACE_FILES" wf ON rt.id = wf.file_id 
     WHERE wf.workspace_id = $1 
     ORDER BY upload_date DESC 
     LIMIT $2 OFFSET $3`,
    [workspaceId, limit, offset]
  );
  return result.rows;
}
